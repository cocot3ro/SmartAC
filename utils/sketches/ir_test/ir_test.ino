// ==== Configuración básica ====
#define IR_LED 25           // GPIO que controla el transistor
#define CARRIER_FREQ 38000  // Frecuencia de portadora (38 kHz)
#define PERIOD_US (1000000 / CARRIER_FREQ)  // Periodo de la portadora (~26 µs)
#define HALF_PERIOD_US (PERIOD_US / 2)      // Semiperiodo (~13 µs)

// ==== Funciones de ayuda ====

// Genera un "burst" de señal IR a 38kHz durante 'duration' microsegundos
void irMark(unsigned long duration) {
  unsigned long start = micros();
  while (micros() - start < duration) {
    digitalWrite(IR_LED, HIGH);
    delayMicroseconds(HALF_PERIOD_US);
    digitalWrite(IR_LED, LOW);
    delayMicroseconds(HALF_PERIOD_US);
  }
}

// Pausa sin señal IR (LED apagado)
void irSpace(unsigned long duration) {
  digitalWrite(IR_LED, LOW);
  if (duration > 0) delayMicroseconds(duration);
}

// Envía una trama IR (lista de tiempos en microsegundos)
void sendIR(const int *rawData, int length) {
  for (int i = 0; i < length; i++) {
    int duration = abs(rawData[i]);
    if (rawData[i] < 0) irMark(duration);   // Pulso (LED encendido)
    else irSpace(duration);                 // Pausa (LED apagado)
  }
}

// ==== Tramas de prueba ====
const int frame1[] = {
  -9000,+4500,
  -615,+1640,-615,+1640,-615,+530,-615,+530,-615,+530,-615,+530,-615,+530,-615,+1640,
  -615,+530,-615,+1640,-615,+1640,-615,+530,-615,+530,-615,+530,-615,+530,-615,+530,
  -615,+1640,-615,+530,-615,+530,-615,+530,-615,+530,-615,+530,-615,+530,-615,+530,
  -615,+530,-615,+530,-615,+1640,-615,+530,-615,+1640,-615,+1640,-615,+1640,-615,+530,
  -615,+530,-615,+530,-615,+530,-615,+530,-615,+530,-615,+530,-615,+530,-615,+530,
  -615,+530,-615,+530,-615,+530,-615,+530,-615,+530,-615,+530,-615,+530,-615,+530,
  -615,+7900,
  -615,+1640,-615,+530,-615,+1640,-615,+530,-615,+530,-615,+530,-615,+530,-615,+1640,
  -615,+1640,-615,+530,-615,+530,-615,+1640,-615,+530,-615,+1640,-615,+530,-615,+530,
  -615,+530,-615,+530,-615,+530,-615,+530,-615,+530,-615,+530,-615,+530,-615,+530,
  -615,+530,-615,+530,-615,+530,-615,+530,-615,+530,-615,+530,-615,+530,-615,+530,
  -615,+530,-615,+530,-615,+530,-615,+530,-615,+530,-615,+530,-615,+530,-615,+530,
  -615,+530,-615,+530,-615,+530,-615,+530,-615,+530,-615,+530,-615,+530,-615,+530,
  -615,+530,-615,+530,-615,+530,-615,+530,-615,+530,-615,+530,-615,+530,-615,+530,
  -615,+1640,-615,+530,-615,+530,-615,+1640,-615,+1640,-615,+530,-615,+1640,-615,+1640,
  -615,+7900,
  -615,+530,-615,+530,-615,+530,-615,+530,-615,+530,-615,+530,-615,+530,-615,+530,
  -615,+1640,-615,+530,-615,+530,-615,+530,-615,+1640,-615,+530,-615,+530,-615,+530,
  -615,+530,-615,+530,-615,+530,-615,+530,-615,+530,-615,+530,-615,+530,-615,+530,
  -615,+530,-615,+530,-615,+530,-615,+530,-615,+530,-615,+530,-615,+530,-615,+530,
  -615,+530,-615,+530,-615,+530,-615,+1640,-615,+530,-615,+530,-615,+530,-615,+530,
  -615,+530,-615,+530,-615,+530,-615,+530,-615,+530,-615,+530,-615,+530,-615,+530,
  -615,+1640,-615,+530,-615,+530,-615,+1640,-615,+1640,-615,+530,-615,+530,-615,+530,
  -615
};
const int frame2[] = {
  -9000,+4500,
  -615,+1640,-615,+1640,-615,+530,-615,+530,-615,+530,-615,+530,-615,+530,-615,+1640,
  -615,+530,-615,+1640,-615,+1640,-615,+530,-615,+530,-615,+530,-615,+530,-615,+530,
  -615,+530,-615,+1640,-615,+530,-615,+530,-615,+530,-615,+530,-615,+530,-615,+530,
  -615,+530,-615,+530,-615,+1640,-615,+530,-615,+1640,-615,+1640,-615,+1640,-615,+530,
  -615,+530,-615,+530,-615,+530,-615,+530,-615,+530,-615,+530,-615,+530,-615,+530,
  -615,+530,-615,+530,-615,+530,-615,+530,-615,+530,-615,+530,-615,+530,-615,+530,
  -615,+7900,
  -615,+1640,-615,+530,-615,+1640,-615,+530,-615,+530,-615,+530,-615,+530,-615,+1640,
  -615,+1640,-615,+530,-615,+530,-615,+1640,-615,+530,-615,+1640,-615,+530,-615,+530,
  -615,+530,-615,+530,-615,+530,-615,+530,-615,+530,-615,+530,-615,+530,-615,+530,
  -615,+530,-615,+530,-615,+530,-615,+530,-615,+530,-615,+530,-615,+530,-615,+530,
  -615,+530,-615,+530,-615,+530,-615,+530,-615,+530,-615,+530,-615,+530,-615,+530,
  -615,+530,-615,+530,-615,+530,-615,+530,-615,+530,-615,+530,-615,+530,-615,+530,
  -615,+530,-615,+530,-615,+530,-615,+530,-615,+530,-615,+530,-615,+530,-615,+530,
  -615,+530,-615,+1640,-615,+530,-615,+1640,-615,+1640,-615,+530,-615,+1640,-615,+1640,
  -615,+7900,
  -615,+530,-615,+530,-615,+530,-615,+530,-615,+530,-615,+530,-615,+530,-615,+530,
  -615,+1640,-615,+530,-615,+530,-615,+530,-615,+1640,-615,+530,-615,+530,-615,+530,
  -615,+530,-615,+530,-615,+530,-615,+530,-615,+530,-615,+530,-615,+530,-615,+530,
  -615,+530,-615,+530,-615,+530,-615,+530,-615,+530,-615,+530,-615,+530,-615,+530,
  -615,+530,-615,+530,-615,+530,-615,+1640,-615,+530,-615,+530,-615,+530,-615,+530,
  -615,+530,-615,+530,-615,+530,-615,+530,-615,+530,-615,+530,-615,+530,-615,+530,
  -615,+1640,-615,+530,-615,+530,-615,+1640,-615,+1640,-615,+530,-615,+530,-615,+530,
  -615
};
const int frame3[] = {
  -9000,+4500,
  -615,+1640,-615,+1640,-615,+530,-615,+530,-615,+530,-615,+530,-615,+530,-615,+1640,
  -615,+530,-615,+1640,-615,+1640,-615,+530,-615,+530,-615,+530,-615,+530,-615,+530,
  -615,+1640,-615,+1640,-615,+530,-615,+530,-615,+530,-615,+530,-615,+530,-615,+530,
  -615,+530,-615,+530,-615,+1640,-615,+530,-615,+1640,-615,+1640,-615,+1640,-615,+530,
  -615,+530,-615,+530,-615,+530,-615,+530,-615,+530,-615,+530,-615,+530,-615,+530,
  -615,+530,-615,+530,-615,+530,-615,+530,-615,+530,-615,+530,-615,+530,-615,+530,
  -615,+7900,
  -615,+1640,-615,+530,-615,+1640,-615,+530,-615,+530,-615,+530,-615,+530,-615,+1640,
  -615,+1640,-615,+530,-615,+530,-615,+1640,-615,+530,-615,+1640,-615,+530,-615,+530,
  -615,+530,-615,+530,-615,+530,-615,+530,-615,+530,-615,+530,-615,+530,-615,+530,
  -615,+530,-615,+530,-615,+530,-615,+530,-615,+530,-615,+530,-615,+530,-615,+530,
  -615,+530,-615,+530,-615,+530,-615,+530,-615,+530,-615,+530,-615,+530,-615,+530,
  -615,+530,-615,+530,-615,+530,-615,+530,-615,+530,-615,+530,-615,+530,-615,+530,
  -615,+530,-615,+530,-615,+530,-615,+530,-615,+530,-615,+530,-615,+530,-615,+530,
  -615,+1640,-615,+1640,-615,+530,-615,+1640,-615,+1640,-615,+530,-615,+1640,-615,+1640,
  -615,+7900,
  -615,+530,-615,+530,-615,+530,-615,+530,-615,+530,-615,+530,-615,+530,-615,+530,
  -615,+1640,-615,+530,-615,+530,-615,+530,-615,+1640,-615,+530,-615,+530,-615,+530,
  -615,+530,-615,+530,-615,+530,-615,+530,-615,+530,-615,+530,-615,+530,-615,+530,
  -615,+530,-615,+530,-615,+530,-615,+530,-615,+530,-615,+530,-615,+530,-615,+530,
  -615,+530,-615,+530,-615,+530,-615,+1640,-615,+530,-615,+530,-615,+530,-615,+530,
  -615,+530,-615,+530,-615,+530,-615,+530,-615,+530,-615,+530,-615,+530,-615,+530,
  -615,+1640,-615,+530,-615,+530,-615,+1640,-615,+1640,-615,+530,-615,+530,-615,+530,
  -615
};

// ==== Programa principal ====
void setup() {
  pinMode(IR_LED, OUTPUT);
  digitalWrite(IR_LED, LOW);
  Serial.begin(115200);
  Serial.println("Prueba de envío de tramas IR...");
}

void loop() {
  Serial.println("Enviando trama 1 (FAN HIGH) ...");
  sendIR(frame1, sizeof(frame1) / sizeof(frame1[0]));
  delay(2000);

  Serial.println("Enviando trama 2 (FAN MEDIUM) ...");
  sendIR(frame2, sizeof(frame2) / sizeof(frame2[0]));
  delay(2000);

  Serial.println("Enviando trama 3 (FAN LOW) ...");
  sendIR(frame3, sizeof(frame3) / sizeof(frame3[0]));
  delay(5000);  // más pausa antes de repetir
}
